jQuery.trumbowyg={langs:{en:{viewHTML:"View HTML",undo:"Undo",redo:"Redo",formatting:"Formatting",p:"Paragraph",blockquote:"Quote",code:"Code",header:"Header",bold:"Bold",italic:"Italic",strikethrough:"Strikethrough",underline:"Underline",strong:"Strong",em:"Emphasis",del:"Deleted",superscript:"Superscript",subscript:"Subscript",unorderedList:"Unordered list",orderedList:"Ordered list",insertImage:"Insert Image",link:"Link",createLink:"Insert link",unlink:"Remove link",justifyLeft:"Align Left",justifyCenter:"Align Center",justifyRight:"Align Right",justifyFull:"Align Justify",horizontalRule:"Insert horizontal rule",removeformat:"Remove format",fullscreen:"Fullscreen",close:"Close",submit:"Confirm",reset:"Cancel",required:"Required",description:"Description",title:"Title",text:"Text",target:"Target",width:"Width"}},plugins:{},svgPath:null,hideButtonTexts:null},Object.defineProperty(jQuery.trumbowyg,"defaultOptions",{value:{lang:"en",fixedBtnPane:!1,fixedFullWidth:!1,autogrow:!1,autogrowOnEnter:!1,imageWidthModalEdit:!1,prefix:"trumbowyg-",semantic:!0,semanticKeepAttributes:!1,resetCss:!1,removeformatPasted:!1,tabToIndent:!1,tagsToRemove:[],tagsToKeep:["hr","img","embed","iframe","input"],btns:[["viewHTML"],["undo","redo"],["formatting"],["strong","em","del"],["superscript","subscript"],["link"],["insertImage"],["justifyLeft","justifyCenter","justifyRight","justifyFull"],["unorderedList","orderedList"],["horizontalRule"],["removeformat"],["fullscreen"]],btnsDef:{},changeActiveDropdownIcon:!1,inlineElementsSelector:"a,abbr,acronym,b,caption,cite,code,col,dfn,dir,dt,dd,em,font,hr,i,kbd,li,q,span,strikeout,strong,sub,sup,u",pasteHandlers:[],plugins:{},urlProtocol:!1,minimalLinks:!1,defaultLinkTarget:void 0},writable:!1,enumerable:!0,configurable:!1}),function(e,t,o,a){"use strict";a.fn.trumbowyg=function(e,t){if(e===Object(e)||!e)return this.each(function(){a(this).data("trumbowyg")||a(this).data("trumbowyg",new n(this,e))});if(1===this.length)try{var o=a(this).data("trumbowyg");switch(e){case"execCmd":return o.execCmd(t.cmd,t.param,t.forceCss,t.skipTrumbowyg);case"openModal":return o.openModal(t.title,t.content);case"closeModal":return o.closeModal();case"openModalInsert":return o.openModalInsert(t.title,t.fields,t.callback);case"saveRange":return o.saveRange();case"getRange":return o.range;case"getRangeText":return o.getRangeText();case"restoreRange":return o.restoreRange();case"enable":return o.setDisabled(!1);case"disable":return o.setDisabled(!0);case"toggle":return o.toggle();case"destroy":return o.destroy();case"empty":return o.empty();case"html":return o.html(t)}}catch(e){}return!1};var n=function(n,r){var i=this,l=a.trumbowyg;i.doc=n.ownerDocument||o,i.$ta=a(n),i.$c=a(n),null!=(r=r||{}).lang||null!=l.langs[r.lang]?i.lang=a.extend(!0,{},l.langs.en,l.langs[r.lang]):i.lang=l.langs.en,i.hideButtonTexts=null!=l.hideButtonTexts?l.hideButtonTexts:r.hideButtonTexts;var s=null!=l.svgPath?l.svgPath:r.svgPath;if(i.hasSvg=!1!==s,i.svgPath=i.doc.querySelector("base")?t.location.href.split("#")[0]:"",0===a("#trumbowyg-icons",i.doc).length&&!1!==s){if(null==s){for(var x=o.getElementsByTagName("script"),d=0;d<x.length;d+=1){var F=x[d].src,u=F.match("trumbowyg(.min)?.js");null!=u&&(s=F.substring(0,F.indexOf(u[0]))+"ui/icons.svg")}null==s&&console.warn("You must define svgPath: https://goo.gl/CfTY9U")}var c=i.doc.createElement("div");c.id="trumbowyg-icons",i.doc.body.insertBefore(c,i.doc.body.childNodes[0]),a.ajax({async:!0,type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",dataType:"xml",crossDomain:!0,url:s,data:null,beforeSend:null,complete:null,success:function(e){c.innerHTML=(new XMLSerializer).serializeToString(e.documentElement)}})}var f=i.lang.header,g=function(){return(t.chrome||t.Intl&&Intl.v8BreakIterator)&&"CSS"in t};i.btnsDef={viewHTML:{fn:"toggle",class:"trumbowyg-not-disable"},undo:{isSupported:g,key:"Z"},redo:{isSupported:g,key:"Y"},p:{fn:"formatBlock"},blockquote:{fn:"formatBlock"},h1:{fn:"formatBlock",title:f+" 1"},h2:{fn:"formatBlock",title:f+" 2"},h3:{fn:"formatBlock",title:f+" 3"},h4:{fn:"formatBlock",title:f+" 4"},h5:{fn:"formatBlock",title:f+" 5"},h6:{fn:"formatBlock",title:f+" 6"},subscript:{tag:"sub"},superscript:{tag:"sup"},bold:{key:"B",tag:"b"},italic:{key:"I",tag:"i"},underline:{tag:"u"},strikethrough:{tag:"strike"},strong:{fn:"bold",key:"B"},em:{fn:"italic",key:"I"},del:{fn:"strikethrough"},createLink:{key:"K",tag:"a"},unlink:{},insertImage:{},justifyLeft:{tag:"left",forceCss:!0},justifyCenter:{tag:"center",forceCss:!0},justifyRight:{tag:"right",forceCss:!0},justifyFull:{tag:"justify",forceCss:!0},unorderedList:{fn:"insertUnorderedList",tag:"ul"},orderedList:{fn:"insertOrderedList",tag:"ol"},horizontalRule:{fn:"insertHorizontalRule"},removeformat:{},fullscreen:{class:"trumbowyg-not-disable"},close:{fn:"destroy",class:"trumbowyg-not-disable"},formatting:{dropdown:["p","blockquote","h1","h2","h3","h4"],ico:"p"},link:{dropdown:["createLink","unlink"]}},i.o=a.extend(!0,{},l.defaultOptions,r),i.o.hasOwnProperty("imgDblClickHandler")||(i.o.imgDblClickHandler=i.getDefaultImgDblClickHandler()),i.urlPrefix=i.setupUrlPrefix(),i.disabled=i.o.disabled||"TEXTAREA"===n.nodeName&&n.disabled,r.btns?i.o.btns=r.btns:i.o.semantic||(i.o.btns[3]=["bold","italic","underline","strikethrough"]),a.each(i.o.btnsDef,function(e,t){i.addBtnDef(e,t)}),i.eventNamespace="trumbowyg-event",i.keys=[],i.tagToButton={},i.tagHandlers=[],i.pasteHandlers=[].concat(i.o.pasteHandlers),i.isIE=-1!==e.userAgent.indexOf("MSIE")||-1!==e.appVersion.indexOf("Trident/"),i.isMac=-1!==e.platform.toUpperCase().indexOf("MAC"),i.init()};n.prototype={DEFAULT_SEMANTIC_MAP:{b:"strong",i:"em",s:"del",strike:"del",div:"p"},init:function(){var e=this;e.height=e.$ta.height(),e.initPlugins();try{e.doc.execCommand("enableObjectResizing",!1,!1),e.doc.execCommand("defaultParagraphSeparator",!1,"p")}catch(e){}e.buildEditor(),e.buildBtnPane(),e.fixedBtnPaneEvents(),e.buildOverlay(),setTimeout(function(){e.disabled&&e.setDisabled(!0),e.$c.trigger("tbwinit")})},addBtnDef:function(e,t){this.btnsDef[e]=a.extend(t,this.btnsDef[e]||{})},setupUrlPrefix:function(){var e=this.o.urlProtocol;if(e)return"string"!=typeof e?"https://":e.replace("://","")+"://"},buildEditor:function(){var e=this,o=e.o.prefix,n="";e.$box=a("<div/>",{class:o+"box "+o+"editor-visible "+o+e.o.lang+" trumbowyg"}),e.isTextarea=e.$ta.is("textarea"),e.isTextarea?(n=e.$ta.val(),e.$ed=a("<div/>"),e.$box.insertAfter(e.$ta).append(e.$ed,e.$ta)):(e.$ed=e.$ta,n=e.$ed.html(),e.$ta=a("<textarea/>",{name:e.$ta.attr("id"),height:e.height}).val(n),e.$box.insertAfter(e.$ed).append(e.$ta,e.$ed),e.syncCode()),e.$ta.addClass(o+"textarea").attr("tabindex",-1),e.$ed.addClass(o+"editor").attr({contenteditable:!0,dir:e.lang._dir||"ltr"}).html(n),e.o.tabindex&&e.$ed.attr("tabindex",e.o.tabindex),e.$c.is("[placeholder]")&&e.$ed.attr("placeholder",e.$c.attr("placeholder")),e.$c.is("[spellcheck]")&&e.$ed.attr("spellcheck",e.$c.attr("spellcheck")),e.o.resetCss&&e.$ed.addClass(o+"reset-css"),e.o.autogrow||e.$ta.add(e.$ed).css({height:e.height}),e.semanticCode(),e.o.autogrowOnEnter&&e.$ed.addClass(o+"autogrow-on-enter");var r,i=!1,l=!1;e.$ed.on("dblclick","img",e.o.imgDblClickHandler).on("keydown",function(t){if(!t.ctrlKey&&!t.metaKey||t.altKey){if(e.o.tabToIndent&&"Tab"===t.key)try{return t.shiftKey?e.execCmd("outdent",!0,null):e.execCmd("indent",!0,null),!1}catch(e){}}else{i=!0;var o=e.keys[String.fromCharCode(t.which).toUpperCase()];try{return e.execCmd(o.fn,o.param),!1}catch(e){}}}).on("compositionstart compositionupdate",function(){l=!0}).on("keyup compositionend",function(t){if("compositionend"===t.type)l=!1;else if(l)return;var o=t.which;if(!(o>=37&&o<=40)){if(!t.ctrlKey&&!t.metaKey||89!==o&&90!==o)if(i||17===o)void 0===t.which&&e.semanticCode(!1,!1,!0);else{var a=!e.isIE||"compositionend"===t.type;e.semanticCode(!1,a&&13===o),e.$c.trigger("tbwchange")}else e.semanticCode(!1,!0),e.$c.trigger("tbwchange");setTimeout(function(){i=!1},50)}}).on("mouseup keydown keyup",function(t){(!t.ctrlKey&&!t.metaKey||t.altKey)&&setTimeout(function(){i=!1},50),clearTimeout(r),r=setTimeout(function(){e.updateButtonPaneStatus()},50)}).on("focus blur",function(t){if("blur"===t.type&&e.clearButtonPaneStatus(),e.$c.trigger("tbw"+t.type),e.o.autogrowOnEnter){if(e.autogrowOnEnterDontClose)return;"focus"===t.type?(e.autogrowOnEnterWasFocused=!0,e.autogrowEditorOnEnter()):e.o.autogrow||(e.$ed.css({height:e.$ed.css("min-height")}),e.$c.trigger("tbwresize"))}}).on("keyup focus",function(){e.$ta.val().match(/<.*>/)||setTimeout(function(){var t=e.isIE?"<p>":"p";e.doc.execCommand("formatBlock",!1,t),e.syncCode()},0)}).on("cut drop",function(){setTimeout(function(){e.semanticCode(!1,!0),e.$c.trigger("tbwchange")},0)}).on("paste",function(o){if(e.o.removeformatPasted){o.preventDefault(),t.getSelection&&t.getSelection().deleteFromDocument&&t.getSelection().deleteFromDocument();try{var n=t.clipboardData.getData("Text");try{e.doc.selection.createRange().pasteHTML(n)}catch(t){e.doc.getSelection().getRangeAt(0).insertNode(e.doc.createTextNode(n))}e.$c.trigger("tbwchange",o)}catch(t){e.execCmd("insertText",(o.originalEvent||o).clipboardData.getData("text/plain"))}}a.each(e.pasteHandlers,function(e,t){t(o)}),setTimeout(function(){e.semanticCode(!1,!0),e.$c.trigger("tbwpaste",o),e.$c.trigger("tbwchange")},0)}),e.$ta.on("keyup",function(){e.$c.trigger("tbwchange")}).on("paste",function(){setTimeout(function(){e.$c.trigger("tbwchange")},0)}),a(e.doc.body).on("keydown."+e.eventNamespace,function(t){if(27===t.which&&a("."+o+"modal-box").length>=1)return e.closeModal(),!1})},autogrowEditorOnEnter:function(){var e=this;e.$ed.removeClass("autogrow-on-enter");var t=e.$ed[0].clientHeight;e.$ed.height("auto");var o=e.$ed[0].scrollHeight;e.$ed.addClass("autogrow-on-enter"),t!==o&&(e.$ed.height(t),setTimeout(function(){e.$ed.css({height:o}),e.$c.trigger("tbwresize")},0))},buildBtnPane:function(){var e=this,t=e.o.prefix,o=e.$btnPane=a("<div/>",{class:t+"button-pane"});a.each(e.o.btns,function(n,r){a.isArray(r)||(r=[r]);var i=a("<div/>",{class:t+"button-group "+(r.indexOf("fullscreen")>=0?t+"right":"")});a.each(r,function(t,o){try{e.isSupportedBtn(o)&&i.append(e.buildBtn(o))}catch(e){}}),i.html().trim().length>0&&o.append(i)}),e.$box.prepend(o)},buildBtn:function(e){var t=this,o=t.o.prefix,n=t.btnsDef[e],r=n.dropdown,i=null==n.hasIcon||n.hasIcon,l=t.lang[e]||e,s=a("<button/>",{type:"button",class:o+e+"-button "+(n.class||"")+(i?"":" "+o+"textual-button"),html:t.hasSvg&&i?'<svg><use xlink:href="'+t.svgPath+"#"+o+(n.ico||e).replace(/([A-Z]+)/g,"-$1").toLowerCase()+'"/></svg>':t.hideButtonTexts?"":n.text||n.title||t.lang[e]||e,title:(n.title||n.text||l)+(n.key?" ("+(t.isMac?"Cmd":"Ctrl")+" + "+n.key+")":""),tabindex:-1,mousedown:function(){return r&&!a("."+e+"-"+o+"dropdown",t.$box).is(":hidden")||a("body",t.doc).trigger("mousedown"),!((t.$btnPane.hasClass(o+"disable")||t.$box.hasClass(o+"disabled"))&&!a(this).hasClass(o+"active")&&!a(this).hasClass(o+"not-disable"))&&(t.execCmd((!r?n.fn:"dropdown")||e,n.param||e,n.forceCss),!1)}});if(r){s.addClass(o+"open-dropdown");var x=o+"dropdown",d={class:x+"-"+e+" "+x+" "+o+"fixed-top "+(n.dropdownClass||"")};d["data-"+x]=e;var F=a("<div/>",d);a.each(r,function(e,o){t.btnsDef[o]&&t.isSupportedBtn(o)&&F.append(t.buildSubBtn(o))}),t.$box.append(F.hide())}else n.key&&(t.keys[n.key]={fn:n.fn||e,param:n.param||e});return r||(t.tagToButton[(n.tag||e).toLowerCase()]=e),s},buildSubBtn:function(e){var t=this,o=t.o.prefix,n=t.btnsDef[e],r=null==n.hasIcon||n.hasIcon;return n.key&&(t.keys[n.key]={fn:n.fn||e,param:n.param||e}),t.tagToButton[(n.tag||e).toLowerCase()]=e,a("<button/>",{type:"button",class:o+e+"-dropdown-button "+(n.class||"")+(n.ico?" "+o+n.ico+"-button":""),html:t.hasSvg&&r?'<svg><use xlink:href="'+t.svgPath+"#"+o+(n.ico||e).replace(/([A-Z]+)/g,"-$1").toLowerCase()+'"/></svg>'+(n.text||n.title||t.lang[e]||e):n.text||n.title||t.lang[e]||e,title:n.key?"("+(t.isMac?"Cmd":"Ctrl")+" + "+n.key+")":null,style:n.style||null,mousedown:function(){return a("body",t.doc).trigger("mousedown"),t.execCmd(n.fn||e,n.param||e,n.forceCss),!1}})},isSupportedBtn:function(e){try{return this.btnsDef[e].isSupported()}catch(e){}return!0},buildOverlay:function(){var e=this;return e.$overlay=a("<div/>",{class:e.o.prefix+"overlay"}).appendTo(e.$box),e.$overlay},showOverlay:function(){var e=this;a(t).trigger("scroll"),e.$overlay.fadeIn(200),e.$box.addClass(e.o.prefix+"box-blur")},hideOverlay:function(){var e=this;e.$overlay.fadeOut(50),e.$box.removeClass(e.o.prefix+"box-blur")},fixedBtnPaneEvents:function(){var e=this,o=e.o.fixedFullWidth,n=e.$box;e.o.fixedBtnPane&&(e.isFixed=!1,a(t).on("scroll."+e.eventNamespace+" resize."+e.eventNamespace,function(){if(n){e.syncCode();var r=a(t).scrollTop(),i=n.offset().top+1,l=e.$btnPane,s=l.outerHeight()-2;r-i>0&&r-i-e.height<0?(e.isFixed||(e.isFixed=!0,l.css({position:"fixed",top:0,left:o?0:"auto",zIndex:7}),e.$box.css({paddingTop:l.height()})),l.css({width:o?"100%":n.width()-1}),a("."+e.o.prefix+"fixed-top",n).css({position:o?"fixed":"absolute",top:o?s:s+(r-i),zIndex:15})):e.isFixed&&(e.isFixed=!1,l.removeAttr("style"),e.$box.css({paddingTop:0}),a("."+e.o.prefix+"fixed-top",n).css({position:"absolute",top:s}))}}))},setDisabled:function(e){var t=this,o=t.o.prefix;t.disabled=e,e?t.$ta.attr("disabled",!0):t.$ta.removeAttr("disabled"),t.$box.toggleClass(o+"disabled",e),t.$ed.attr("contenteditable",!e)},destroy:function(){var e=this,o=e.o.prefix;e.isTextarea?e.$box.after(e.$ta.css({height:""}).val(e.html()).removeClass(o+"textarea").show()):e.$box.after(e.$ed.css({height:""}).removeClass(o+"editor").removeAttr("contenteditable").removeAttr("dir").html(e.html()).show()),e.$ed.off("dblclick","img"),e.destroyPlugins(),e.$box.remove(),e.$c.removeData("trumbowyg"),a("body").removeClass(o+"body-fullscreen"),e.$c.trigger("tbwclose"),a(t).off("scroll."+e.eventNamespace+" resize."+e.eventNamespace),a(e.doc.body).off("keydown."+e.eventNamespace)},empty:function(){this.$ta.val(""),this.syncCode(!0)},toggle:function(){var e=this,t=e.o.prefix;e.o.autogrowOnEnter&&(e.autogrowOnEnterDontClose=!e.$box.hasClass(t+"editor-hidden")),e.semanticCode(!1,!0),e.$c.trigger("tbwchange"),setTimeout(function(){e.doc.activeElement.blur(),e.$box.toggleClass(t+"editor-hidden "+t+"editor-visible"),e.$btnPane.toggleClass(t+"disable"),a("."+t+"viewHTML-button",e.$btnPane).toggleClass(t+"active"),e.$box.hasClass(t+"editor-visible")?e.$ta.attr("tabindex",-1):e.$ta.removeAttr("tabindex"),e.o.autogrowOnEnter&&!e.autogrowOnEnterDontClose&&e.autogrowEditorOnEnter()},0)},dropdown:function(e){var o=this,n=a("body",o.doc),r=o.o.prefix,i=a("[data-"+r+"dropdown="+e+"]",o.$box),l=a("."+r+e+"-button",o.$btnPane),s=i.is(":hidden");if(n.trigger("mousedown"),s){var x=l.offset().left;l.addClass(r+"active"),i.css({position:"absolute",top:l.offset().top-o.$btnPane.offset().top+l.outerHeight(),left:o.o.fixedFullWidth&&o.isFixed?x:x-o.$btnPane.offset().left}).show(),a(t).trigger("scroll"),n.on("mousedown."+o.eventNamespace,function(e){i.is(e.target)||(a("."+r+"dropdown",o.$box).hide(),a("."+r+"active",o.$btnPane).removeClass(r+"active"),n.off("mousedown."+o.eventNamespace))})}},html:function(e){var t=this;return null!=e?(t.$ta.val(e),t.syncCode(!0),t.$c.trigger("tbwchange"),t):t.$ta.val()},syncTextarea:function(){var e=this;e.$ta.val(e.$ed.text().trim().length>0||e.$ed.find(e.o.tagsToKeep.join(",")).length>0?e.$ed.html():"")},syncCode:function(e){var t=this;if(!e&&t.$ed.is(":visible"))t.syncTextarea();else{var o=a("<div>").html(t.$ta.val()),n=a("<div>").append(o);a(t.o.tagsToRemove.join(","),n).remove(),t.$ed.html(n.contents().html())}if(t.o.autogrow&&(t.height=t.$ed.height(),t.height!==t.$ta.css("height")&&(t.$ta.css({height:t.height}),t.$c.trigger("tbwresize"))),t.o.autogrowOnEnter){t.$ed.height("auto");var r=t.autogrowOnEnterWasFocused?t.$ed[0].scrollHeight:t.$ed.css("min-height");r!==t.$ta.css("height")&&(t.$ed.css({height:r}),t.$c.trigger("tbwresize"))}},semanticCode:function(e,t,o){var n=this;if(n.saveRange(),n.syncCode(e),n.o.semantic){if(n.semanticTag("b",n.o.semanticKeepAttributes),n.semanticTag("i",n.o.semanticKeepAttributes),n.semanticTag("s",n.o.semanticKeepAttributes),n.semanticTag("strike",n.o.semanticKeepAttributes),t){var r=n.o.inlineElementsSelector,i=":not("+r+")";n.$ed.contents().filter(function(){return 3===this.nodeType&&this.nodeValue.trim().length>0}).wrap("<span data-tbw/>");var l=function(e){if(0!==e.length){var t=e.nextUntil(i).addBack().wrapAll("<p/>").parent(),o=t.nextAll(r).first();t.next("br").remove(),l(o)}};l(n.$ed.children(r).first()),n.semanticTag("div",!0),a("[data-tbw]",n.$ed).contents().unwrap(),n.$ed.find("p:empty").remove()}o||n.restoreRange(),n.syncTextarea()}},semanticTag:function(e,t){var o;if(null!=this.o.semantic&&"object"==typeof this.o.semantic&&this.o.semantic.hasOwnProperty(e))o=this.o.semantic[e];else{if(!0!==this.o.semantic||!this.DEFAULT_SEMANTIC_MAP.hasOwnProperty(e))return;o=this.DEFAULT_SEMANTIC_MAP[e]}a(e,this.$ed).each(function(){var e=a(this);if(0===e.contents().length)return!1;e.wrap("<"+o+"/>"),t&&a.each(e.prop("attributes"),function(){e.parent().attr(this.name,this.value)}),e.contents().unwrap()})},createLink:function(){for(var e,t,o,n=this,r=n.doc.getSelection(),i=r.getRangeAt(0),l=r.focusNode,s=(new XMLSerializer).serializeToString(i.cloneContents())||i+"";["A","DIV"].indexOf(l.nodeName)<0;)l=l.parentNode;if(l&&"A"===l.nodeName){var x=a(l);s=x.text(),e=x.attr("href"),n.o.minimalLinks||(t=x.attr("title"),o=x.attr("target")||n.o.defaultLinkTarget);var d=n.doc.createRange();d.selectNode(l),r.removeAllRanges(),r.addRange(d)}n.saveRange();var F={url:{label:"URL",required:!0,value:e},text:{label:n.lang.text,value:s}};n.o.minimalLinks||a.extend(F,{title:{label:n.lang.title,value:t},target:{label:n.lang.target,value:o}}),n.openModalInsert(n.lang.createLink,F,function(e){var t=n.prependUrlPrefix(e.url);if(!t.length)return!1;var o=a(['<a href="',t,'">',e.text||e.url,"</a>"].join(""));return e.title&&o.attr("title",e.title),(e.target||n.o.defaultLinkTarget)&&o.attr("target",e.target||n.o.defaultLinkTarget),n.range.deleteContents(),n.range.insertNode(o[0]),n.syncCode(),n.$c.trigger("tbwchange"),!0})},prependUrlPrefix:function(e){if(!this.urlPrefix)return e;if(/^([a-z][-+.a-z0-9]*:|\/|#)/i.test(e))return e;return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?"mailto:"+e:this.urlPrefix+e},unlink:function(){var e=this,t=e.doc.getSelection(),o=t.focusNode;if(t.isCollapsed){for(;["A","DIV"].indexOf(o.nodeName)<0;)o=o.parentNode;if(o&&"A"===o.nodeName){var a=e.doc.createRange();a.selectNode(o),t.removeAllRanges(),t.addRange(a)}}e.execCmd("unlink",void 0,void 0,!0)},insertImage:function(){var e=this;e.saveRange();var t={url:{label:"URL",required:!0},alt:{label:e.lang.description,value:e.getRangeText()}};e.o.imageWidthModalEdit&&(t.width={}),e.openModalInsert(e.lang.insertImage,t,function(t){e.execCmd("insertImage",t.url,!1,!0);var o=a('img[src="'+t.url+'"]:not([alt])',e.$box);return o.attr("alt",t.alt),e.o.imageWidthModalEdit&&o.attr({width:t.width}),e.syncCode(),e.$c.trigger("tbwchange"),!0})},fullscreen:function(){var e,o=this,n=o.o.prefix,r=n+"fullscreen",i=r+"-placeholder",l=o.$box.outerHeight();o.$box.toggleClass(r),(e=o.$box.hasClass(r))?o.$box.before(a("<div/>",{class:i}).css({height:l})):a("."+i).remove(),a("body").toggleClass(n+"body-fullscreen",e),a(t).trigger("scroll"),o.$c.trigger("tbw"+(e?"open":"close")+"fullscreen")},execCmd:function(e,t,o,a){var n=this;a=!!a||"","dropdown"!==e&&n.$ed.focus();try{n.doc.execCommand("styleWithCSS",!1,o||!1)}catch(e){}try{n[e+a](t)}catch(o){try{e(t)}catch(o){"insertHorizontalRule"===e?t=void 0:"formatBlock"===e&&n.isIE&&(t="<"+t+">"),n.doc.execCommand(e,!1,t),n.syncCode(),n.semanticCode(!1,!0)}"dropdown"!==e&&(n.updateButtonPaneStatus(),n.$c.trigger("tbwchange"))}},openModal:function(e,o,n){var r=this,i=r.o.prefix;if(n=!1!==n,a("."+i+"modal-box",r.$box).length>0)return!1;r.o.autogrowOnEnter&&(r.autogrowOnEnterDontClose=!0),r.saveRange(),r.showOverlay(),r.$btnPane.addClass(i+"disable");var l,s=a("<div/>",{class:i+"modal "+i+"fixed-top"}).css({}).appendTo(a(r.$btnPane));r.$overlay.one("click",function(){return s.trigger("tbwcancel"),!1}),l=n?a("<form/>",{action:"",html:o}).on("submit",function(){return s.trigger("tbwconfirm"),!1}).on("reset",function(){return s.trigger("tbwcancel"),!1}).on("submit reset",function(){r.o.autogrowOnEnter&&(r.autogrowOnEnterDontClose=!1)}):o;var x=a("<div/>",{class:i+"modal-box",html:l}).css({top:"-"+r.$btnPane.outerHeight(),opacity:0,paddingBottom:n?null:"5%"}).appendTo(s).animate({top:0,opacity:1},100);return e&&a("<span/>",{text:e,class:i+"modal-title"}).prependTo(x),n&&(a("input:first",x).focus(),r.buildModalBtn("submit",x),r.buildModalBtn("reset",x),s.height(x.outerHeight()+10)),a(t).trigger("scroll"),r.$c.trigger("tbwmodalopen"),s},buildModalBtn:function(e,t){var o=this.o.prefix;return a("<button/>",{class:o+"modal-button "+o+"modal-"+e,type:e,text:this.lang[e]||e}).appendTo(a("form",t))},closeModal:function(){var e=this,t=e.o.prefix;e.$btnPane.removeClass(t+"disable"),e.$overlay.off();var o=a("."+t+"modal-box",a(e.doc.body));o.animate({top:"-"+o.height()},100,function(){o.parent().remove(),e.hideOverlay(),e.$c.trigger("tbwmodalclose")}),e.restoreRange()},openModalInsert:function(e,t,o){var n=this,r=n.o.prefix,i=n.lang,l="";return a.each(t,function(e,t){var o=t.label||e,a=t.name||e,n=t.attributes||{},s=Object.keys(n).map(function(e){return e+'="'+n[e]+'"'}).join(" ");l+='<label><input type="'+(t.type||"text")+'" name="'+a+'"'+("checkbox"===t.type&&t.value?' checked="checked"':' value="'+(t.value||"").replace(/"/g,"&quot;"))+'"'+s+'><span class="'+r+'input-infos"><span>'+(i[o]?i[o]:o)+"</span></span></label>"}),n.openModal(e,l).on("tbwconfirm",function(){var e=a("form",a(this)),r=!0,i={};a.each(t,function(t,o){var l=o.name||t,s=a('input[name="'+l+'"]',e);switch(s.attr("type").toLowerCase()){case"checkbox":i[l]=s.is(":checked");break;case"radio":i[l]=s.filter(":checked").val();break;default:i[l]=a.trim(s.val())}o.required&&""===i[l]?(r=!1,n.addErrorOnModalField(s,n.lang.required)):o.pattern&&!o.pattern.test(i[l])&&(r=!1,n.addErrorOnModalField(s,o.patternError))}),r&&(n.restoreRange(),o(i,t)&&(n.syncCode(),n.$c.trigger("tbwchange"),n.closeModal(),a(this).off("tbwconfirm")))}).one("tbwcancel",function(){a(this).off("tbwconfirm"),n.closeModal()})},addErrorOnModalField:function(e,t){var o=this.o.prefix,n=o+"msg-error",r=e.parent();e.on("change keyup",function(){r.removeClass(o+"input-error"),setTimeout(function(){r.find("."+n).remove()},150)}),r.addClass(o+"input-error").find("input+span").append(a("<span/>",{class:n,text:t}))},getDefaultImgDblClickHandler:function(){var e=this;return function(){var t=a(this),o=t.attr("src");0===o.indexOf("data:image")&&(o="(Base64)");var n={url:{label:"URL",value:o,required:!0},alt:{label:e.lang.description,value:t.attr("alt")}};return e.o.imageWidthModalEdit&&(n.width={value:t.attr("width")?t.attr("width"):""}),e.openModalInsert(e.lang.insertImage,n,function(o){return"(Base64)"!==o.url&&t.attr({src:o.url}),t.attr({alt:o.alt}),e.o.imageWidthModalEdit&&(parseInt(o.width)>0?t.attr({width:o.width}):t.removeAttr("width")),!0}),!1}},saveRange:function(){var e=this,t=e.doc.getSelection();if(e.range=null,t&&t.rangeCount){var o,a=e.range=t.getRangeAt(0),n=e.doc.createRange();n.selectNodeContents(e.$ed[0]),n.setEnd(a.startContainer,a.startOffset),o=(n+"").length,e.metaRange={start:o,end:o+(a+"").length}}},restoreRange:function(){var e,t=this,o=t.metaRange,a=t.range,n=t.doc.getSelection();if(a){if(o&&o.start!==o.end){var r,i=0,l=[t.$ed[0]],s=!1,x=!1;for(e=t.doc.createRange();!x&&(r=l.pop());)if(3===r.nodeType){var d=i+r.length;!s&&o.start>=i&&o.start<=d&&(e.setStart(r,o.start-i),s=!0),s&&o.end>=i&&o.end<=d&&(e.setEnd(r,o.end-i),x=!0),i=d}else for(var F=r.childNodes,u=F.length;u>0;)u-=1,l.push(F[u])}try{n.removeAllRanges()}catch(e){}n.addRange(e||a)}},getRangeText:function(){return this.range+""},clearButtonPaneStatus:function(){var e=this,t=e.o.prefix,o=t+"active-button "+t+"active",n=t+"original-icon";a("."+t+"active-button",e.$btnPane).removeClass(o),a("."+n,e.$btnPane).each(function(){a(this).find("svg use").attr("xlink:href",a(this).data(n))})},updateButtonPaneStatus:function(){var e=this,t=e.o.prefix,o=t+"active-button "+t+"active",n=t+"original-icon",r=e.getTagsRecursive(e.doc.getSelection().focusNode);e.clearButtonPaneStatus(),a.each(r,function(r,i){var l=e.tagToButton[i.toLowerCase()],s=a("."+t+l+"-button",e.$btnPane);if(s.length>0)s.addClass(o);else try{var x=(s=a("."+t+"dropdown ."+t+l+"-dropdown-button",e.$box)).find("svg use"),d=s.parent().data(t+"dropdown"),F=a("."+t+d+"-button",e.$box),u=F.find("svg use");F.addClass(o),e.o.changeActiveDropdownIcon&&x.length>0&&(F.addClass(n).data(n,u.attr("xlink:href")),u.attr("xlink:href",x.attr("xlink:href")))}catch(e){}})},getTagsRecursive:function(e,t){var o=this;if(t=t||(e&&e.tagName?[e.tagName]:[]),!e||!e.parentNode)return t;var n=(e=e.parentNode).tagName;return"DIV"===n?t:("P"===n&&""!==e.style.textAlign&&t.push(e.style.textAlign),a.each(o.tagHandlers,function(a,n){t=t.concat(n(e,o))}),t.push(n),o.getTagsRecursive(e,t).filter(function(e){return null!=e}))},initPlugins:function(){var e=this;e.loadedPlugins=[],a.each(a.trumbowyg.plugins,function(t,o){o.shouldInit&&!o.shouldInit(e)||(o.init(e),o.tagHandler&&e.tagHandlers.push(o.tagHandler),e.loadedPlugins.push(o))})},destroyPlugins:function(){var e=this;a.each(this.loadedPlugins,function(t,o){o.destroy&&o.destroy(e)})}}}(navigator,window,document,jQuery);